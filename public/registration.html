<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Регистрация для бизнеса - Place&Play</title>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Montserrat', sans-serif;
            background: url('https://images.unsplash.com/photo-1526676037777-05a232554f77?auto=format&fit=crop&q=80') fixed;
            background-size: cover;
            background-position: center;
            color: #333;
            line-height: 1.6;
            margin: 0;
            padding: 20px;
            min-height: 100vh;
        }

        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, rgba(247, 198, 199, 0.9), rgba(161, 196, 253, 0.9));
            backdrop-filter: blur(8px);
            z-index: -1;
        }

        .registration-container {
            background-color: #fff;
            padding: 40px;
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            width: 80%;
            max-width: 1200px;
            margin: 0 auto;
            position: relative;
        }

        .registration-container h2 {
            margin-bottom: 20px;
            font-weight: 700;
            color: #113366;
        }

        .registration-container input, .registration-container textarea, .registration-container select {
            width: 100%;
            padding: 12px;
            margin-bottom: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 16px;
        }

        .registration-container button {
            width: 100%;
            padding: 12px;
            background-color: #007bff;
            color: #fff;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: 700;
            font-size: 16px;
        }

        .registration-container button:hover {
            background-color: #0056b3;
        }

        .step {
            display: none;
            transition: opacity 0.3s ease-in-out;
            max-width: 100%;
        }

        .step.active {
            display: block;
            opacity: 1;
        }

        .alert {
            color: #d9534f;
            font-size: 0.9em;
            margin-bottom: 20px;
            background-color: #f8d7da;
            padding: 10px;
            border-radius: 5px;
            border: 1px solid #f5c6cb;
        }

        .progress {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .step-indicator {
            display: flex;
            gap: 5px;
            margin-left: 10px;
        }

        .step-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background-color: #ddd;
        }

        .step-dot.active {
            background-color: #007bff;
        }

        .working-hours {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin-bottom: 20px;
        }

        .day {
            display: flex;
            flex-direction: column;
            align-items: center;
            background-color: #e9ecef;
            padding: 10px;
            border-radius: 5px;
        }

        .day label {
            font-weight: bold;
            margin-bottom: 5px;
        }

        .facilities {
            display: flex;
            flex-wrap: wrap;
            justify-content: space-between;
            margin-bottom: 20px;
        }

        .facility {
            flex: 1 1 30%;
            display: flex;
            align-items: center;
            background-color: #e9ecef;
            padding: 10px;
            border-radius: 5px;
            margin: 5px;
        }

        .facility input {
            margin-right: 10px;
        }

        .price-range {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            background-color: #e9ecef;
            padding: 10px;
            border-radius: 5px;
        }

        .price-range label {
            flex: 1;
            text-align: center;
        }

        .final-step {
            background-color: #f9f9f9;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            margin-top: 20px;
        }

        .final-step h3 {
            margin-bottom: 15px;
            color: #007bff;
            font-size: 1.2em;
        }

        .final-step button {
            background-color: #28a745;
            color: #fff;
            font-weight: bold;
            margin-top: 20px;
        }

        .final-step button:hover {
            background-color: #218838;
        }

        .attributes-container {
            display: flex;
            flex-direction: column;
            gap: 30px;
        }

        .org-info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .attribute-item {
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.05);
            transition: transform 0.2s, box-shadow 0.2s;
        }

        /* Стили для маленьких атрибутов */
        .small-attribute {
            grid-column: span 1;
        }

        /* Стили для атрибутов, занимающих всю ширину */
        .full-width-attribute {
            grid-column: 1 / -1;
        }

        /* Стили для средних атрибутов */
        .attribute-item:not(.small-attribute):not(.full-width-attribute) {
            grid-column: span 2;
        }

        .special-attributes {
            margin-top: 20px;
        }

        .attribute-item label {
            margin: 0 0 20px 0;
            padding-bottom: 10px;
            border-bottom: 2px solid #e9ecef;
            color: #113366;
            font-size: 1.3em;
            position: relative;
            display: block;
            font-weight: 600;
        }

        .attribute-item label::after {
            content: '';
            position: absolute;
            bottom: -2px;
            left: 0;
            width: 50px;
            height: 2px;
            background: linear-gradient(to right, #4a90e2, #113366);
        }

        /* Обновленные стили для удобств */
        .facilities-container {
            width: 100%;
            padding: 15px;
        }

        .facility-group {
            margin-bottom: 20px;
        }

        .facility-group-title {
            color: #113366;
            font-size: 1.1em;
            margin-bottom: 10px;
            padding-bottom: 5px;
            border-bottom: 2px solid #e9ecef;
            position: relative;
        }

        .facility-group-title::after {
            content: '';
            position: absolute;
            bottom: -2px;
            left: 0;
            width: 40px;
            height: 2px;
            background: linear-gradient(to right, #4a90e2, #113366);
        }

        .facility-group-items {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .facility-item {
            background: white;
            border-radius: 8px;
            transition: all 0.2s ease;
        }

        .facility-label {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px 12px;
            cursor: pointer;
            width: 100%;
            transition: background-color 0.2s ease;
        }

        .facility-label:hover {
            background-color: #f8f9fa;
        }

        .facility-checkbox {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }

        .facility-icon {
            font-size: 1.2em;
            display: flex;
            align-items: center;
        }

        .facility-name {
            font-weight: 500;
            color: #495057;
        }

        .facility-item.active .facility-label {
            background: linear-gradient(45deg, #d4edda, #c3e6cb);
            color: #155724;
        }

        .facility-item.inactive .facility-label {
            background: linear-gradient(45deg, #f8d7da, #f5c6cb);
            color: #721c24;
        }

        /* Стили для чекбокса */
        .facility-checkbox {
            appearance: none;
            -webkit-appearance: none;
            width: 20px;
            height: 20px;
            border: 2px solid #ddd;
            border-radius: 4px;
            outline: none;
            cursor: pointer;
            position: relative;
            transition: all 0.2s ease;
        }

        .facility-checkbox:checked {
            background-color: #007bff;
            border-color: #007bff;
        }

        .facility-checkbox:checked::after {
            content: '✓';
            position: absolute;
            color: white;
            font-size: 14px;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }

        .facility-checkbox:hover {
            border-color: #007bff;
        }

        .dynamic-price-container {
            width: 100%;
        }

        .time-range-item {
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            display: grid;
            grid-template-columns: 1fr 1fr 2fr auto;
            gap: 20px;
            align-items: center;
            margin-bottom: 15px;
            transition: transform 0.2s;
        }

        .time-range-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .time-range {
            display: flex;
            align-items: center;
            gap: 10px;
            background: #f8f9fa;
            padding: 8px 15px;
            border-radius: 20px;
        }

        .time-separator {
            color: #666;
            font-weight: 500;
        }

        .price-value {
            display: flex;
            align-items: center;
            gap: 10px;
            background: #d4edda;
            padding: 8px 15px;
            border-radius: 20px;
            color: #155724;
        }

        .currency {
            color: #155724;
            font-weight: 500;
        }

        .price-description {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .delete-range {
            background: #dc3545;
            color: white;
            border: none;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .delete-range:hover {
            background: #c82333;
        }

        .add-time-range {
            background: linear-gradient(45deg, #007bff, #0056b3);
            color: white;
            border: none;
            border-radius: 8px;
            padding: 15px;
            cursor: pointer;
            font-weight: 600;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            transition: transform 0.2s;
        }

        .add-time-range:hover {
            transform: translateY(-2px);
        }

        .add-icon {
            font-size: 1.2em;
        }

        .working-hours-section {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.05);
        }

        .days-container {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-top: 20px;
        }

        .day-schedule {
            display: grid;
            grid-template-columns: 150px 1fr auto;
            align-items: center;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 10px;
            gap: 20px;
        }

        .day-name {
            font-weight: 600;
            color: #113366;
        }

        .time-inputs {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .time-inputs input[type="time"] {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            width: 130px;
        }

        .loading {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 200px;
        }

        .loading-spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #007bff;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .button-group {
            display: flex;
            gap: 20px;
            margin-top: 30px;
        }

        .button-group button {
            padding: 15px 30px;
            font-size: 16px;
            border-radius: 8px;
            transition: all 0.3s ease;
        }

        .button-back {
            background-color: #6c757d !important;
        }

        .button-back:hover {
            background-color: #5a6268 !important;
        }

        @media (max-width: 768px) {
            .org-info-grid {
                grid-template-columns: 1fr;
            }

            .attribute-item,
            .small-attribute,
            .full-width-attribute {
                grid-column: 1 / -1;
            }

            .day-schedule {
                grid-template-columns: 1fr;
                gap: 10px;
            }

            .time-inputs {
                justify-content: space-between;
            }

            .facilities-grid {
                grid-template-columns: 1fr;
            }
        }

        /* Анимация при переключении */
        .facility-item {
            position: relative;
            overflow: hidden;
        }

        .facility-item::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(45deg, rgba(255,255,255,0.1), rgba(255,255,255,0.2));
            transform: translateX(-100%);
            transition: transform 0.3s ease;
        }

        .facility-item:hover::before {
            transform: translateX(100%);
        }

        /* Стили для групп удобств */
        .facility-group {
            margin-bottom: 30px;
        }

        .facility-group-title {
            color: #113366;
            font-size: 1.1em;
            margin-bottom: 15px;
            padding-bottom: 8px;
            border-bottom: 2px solid #e9ecef;
            position: relative;
        }

        .facility-group-title::after {
            content: '';
            position: absolute;
            bottom: -2px;
            left: 0;
            width: 40px;
            height: 2px;
            background: linear-gradient(to right, #4a90e2, #113366);
        }

        .facility-group-items {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        .input-group {
            margin-bottom: 20px;
            position: relative;
        }

        .input-group input {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 16px;
            transition: border-color 0.3s ease;
        }

        .input-error {
            color: #dc3545;
            font-size: 0.85em;
            margin-top: 5px;
            min-height: 20px;
            transition: all 0.3s ease;
        }

        .input-group.error input {
            border-color: #dc3545;
        }

        .input-group.error input:focus {
            box-shadow: 0 0 0 0.2rem rgba(220, 53, 69, 0.25);
        }

        /* Анимация появления ошибки */
        .input-group .input-error {
            opacity: 0;
            transform: translateY(-10px);
        }

        .input-group.error .input-error {
            opacity: 1;
            transform: translateY(0);
        }

        .coordinates-container {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
        }

        .coordinates-hint {
            color: #666;
            font-size: 0.9em;
            margin-bottom: 15px;
        }

        .coordinates-group {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        h4 {
            color: #113366;
            margin: 0 0 10px 0;
        }

        #description {
            min-height: 100px;
            resize: vertical;
        }
    </style>
</head>
<body>
    <div class="registration-container">
        <div class="progress" id="progress">
            <span>Шаг 1 из 3</span>
            <div class="step-indicator">
                <div class="step-dot active"></div>
                <div class="step-dot"></div>
                <div class="step-dot"></div>
            </div>
        </div>
        <h2>Регистрация для бизнеса</h2>
        <p class="alert">Вы планируете зарегистрироваться в системе Place&Play как бизнес организация. Это используется для регистрации и может быть как отвергнуто, так и подтверждено модераторами системы. Пожалуйста, не продолжайте, если вы не представляете бизнес.</p>
        
        <div class="step active" id="step1">
            <div class="input-group">
                <input type="email" id="email" placeholder="Email" required>
                <div class="input-error"></div>
            </div>
            
            <div class="input-group">
                <input type="password" id="password" placeholder="Пароль" required>
                <div class="input-error"></div>
            </div>
            
            <div class="input-group">
                <input type="text" id="phone" placeholder="Телефон в формате +998XXXXXXXXX" required>
                <div class="input-error"></div>
            </div>
            
            <div class="button-group">
                <button onclick="nextStep(2)">Далее</button>
            </div>
        </div>

        <div class="step" id="step2">
            <select id="sportType" required onchange="loadAttributes()">
                <option value="">Выберите вид спорта и тип организации</option>
            </select>
            
            <input type="text" id="orgType" placeholder="Тип организации (например: Теннисные корты)" required>
            
            <textarea id="address" placeholder="Адрес" required></textarea>
            
            <div class="input-group">
                <textarea id="description" placeholder="Описание организации" required></textarea>
                <div class="input-hint">Подробно опишите вашу организацию, предоставляемые услуги и особенности</div>
            </div>
            
            <div class="coordinates-container">
                <h4>Координаты на карте</h4>
                <div class="coordinates-hint">Укажите точные координаты вашей организации для отображения на карте</div>
                
                <div class="coordinates-group">
                    <div class="input-group">
                        <input type="number" id="latitude" placeholder="Широта" step="any" required>
                        <div class="input-hint">Например: 41.2995</div>
                    </div>
                    
                    <div class="input-group">
                        <input type="number" id="longitude" placeholder="Долгота" step="any" required>
                        <div class="input-hint">Например: 69.2401</div>
                    </div>
                </div>
            </div>
            
            <input type="text" id="orgName" placeholder="Название организации" required>
            
            <div class="button-group">
                <button class="button-back" onclick="prevStep(1)">Назад</button>
                <button onclick="nextStep(3)">Далее</button>
            </div>
        </div>

        <div class="step" id="step3">
            <div id="attributes" class="attributes-container"></div>
            <div class="button-group">
                <button class="button-back" onclick="prevStep(2)">Назад</button>
                <button onclick="confirmRegistration()">Завершить регистрацию</button>
            </div>
        </div>
    </div>
    <script>
        document.addEventListener('DOMContentLoaded', loadSports);

        async function loadSports() {
            try {
                console.log('Загрузка списка видов спорта...');
                const response = await fetch('/PlaceAndPlay/api/auth/getListOfSports', {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                        'User-Agent': 'insomnia/10.3.1',
                        'language': 'ru'
                    },
                    credentials: 'include'
                });

                if (!response.ok) {
                    throw new Error(`Ошибка сети: ${response.status}`);
                }

                const sports = await response.json();
                console.log('Полученные данные:', sports);
                
                const sportTypeSelect = document.getElementById('sportType');
                sportTypeSelect.innerHTML = '<option value="">Выберите вид спорта и тип организации</option>';

                sports.forEach(sport => {
                    const option = document.createElement('option');
                    option.value = sport.id;
                    option.textContent = sport.name;
                    sportTypeSelect.appendChild(option);
                });
            } catch (error) {
                console.error('Ошибка при загрузке данных:', error);
                console.error('Детали ошибки:', error.message);
            }
        }

        async function loadAttributes() {
            const sportTypeId = parseInt(document.getElementById('sportType').value);
            const attributesContainer = document.getElementById('attributes');
            attributesContainer.innerHTML = '<div class="loading"><div class="loading-spinner"></div></div>';

            if (!sportTypeId) return;

            try {
                const response = await fetch(`/PlaceAndPlay/api/auth/getAttrModelBySport?sportId=${sportTypeId}`, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                        'User-Agent': 'insomnia/10.3.1',
                        'language': 'ru'
                    },
                    credentials: 'include'
                });

                if (!response.ok) {
                    throw new Error(`Ошибка сети: ${response.status}`);
                }

                const data = await response.json();
                console.log('Полученные атрибуты:', data);

                if (!data || !data.orgInfo || !data.orgInfo.attributes) {
                    throw new Error('Неверный формат данных атрибутов');
                }

                const attributes = data.orgInfo.attributes;
                attributesContainer.innerHTML = '';

                // Создаем основную сетку для атрибутов
                const mainGrid = document.createElement('div');
                mainGrid.className = 'org-info-grid';

                // Создаем контейнер для специальных атрибутов (часы работы и цены)
                const specialContainer = document.createElement('div');
                specialContainer.className = 'special-attributes';

                // Сортируем атрибуты по типам
                Object.entries(attributes).forEach(([key, attribute]) => {
                    if (key === 'openHours' || key === 'pricePerHour') {
                        const itemDiv = createAttributeInput(key, attribute);
                        specialContainer.appendChild(itemDiv);
                    } else {
                        const itemDiv = createAttributeInput(key, attribute);
                        mainGrid.appendChild(itemDiv);
                    }
                });

                // Добавляем сначала основную сетку, затем специальные атрибуты
                attributesContainer.appendChild(mainGrid);
                attributesContainer.appendChild(specialContainer);

                // Сохраняем данные для формы регистрации
                window.selectedSportId = sportTypeId;
                window.selectedSportData = data;

            } catch (error) {
                console.error('Ошибка при загрузке атрибутов:', error);
                attributesContainer.innerHTML = `
                    <div class="error-message">
                        Произошла ошибка при загрузке атрибутов. Пожалуйста, попробуйте позже.<br>
                        <small>${error.message}</small>
                    </div>
                `;
            }
        }

        function createAttributeInput(key, attribute) {
            const itemDiv = document.createElement('div');
            itemDiv.className = 'attribute-item';
            itemDiv.setAttribute('data-attribute', key);
            itemDiv.setAttribute('data-input-type', attribute.input);

            // Определяем размер элемента на основе типа и содержимого
            if (attribute.input === 'boolean' || attribute.input === 'int' || 
                (attribute.input === 'select' && (!attribute.options || attribute.options.length <= 3))) {
                itemDiv.classList.add('small-attribute');
            } else if (attribute.input === 'boolean_group' || attribute.input === 'multiselect' ||
                       attribute.input === 'json' || attribute.input === 'dynamic_time_price') {
                itemDiv.classList.add('full-width-attribute');
            }

            const label = document.createElement('label');
            label.textContent = attribute.name.ru;
            itemDiv.appendChild(label);

            switch (attribute.input) {
                case 'boolean':
                    const checkbox = document.createElement('input');
                    checkbox.type = 'checkbox';
                    checkbox.id = key;
                    checkbox.checked = attribute.value || false;
                    itemDiv.appendChild(checkbox);
                    break;

                case 'int':
                    const intInput = document.createElement('input');
                    intInput.type = 'number';
                    intInput.id = key;
                    intInput.value = attribute.value || 0;
                    intInput.step = '1';
                    itemDiv.appendChild(intInput);
                    break;

                case 'multiselect':
                    const selectContainer = document.createElement('div');
                    selectContainer.className = 'multiselect-container';
                    
                    attribute.options.forEach(option => {
                        const optionDiv = document.createElement('div');
                        optionDiv.className = 'multiselect-option';
                        
                        const checkbox = document.createElement('input');
                        checkbox.type = 'checkbox';
                        checkbox.id = `${key}_${option.id}`;
                        checkbox.value = option.id;
                        checkbox.checked = attribute.value?.includes(option.id);
                        
                        const optionLabel = document.createElement('label');
                        optionLabel.htmlFor = `${key}_${option.id}`;
                        optionLabel.textContent = option.name.ru;
                        
                        optionDiv.appendChild(checkbox);
                        optionDiv.appendChild(optionLabel);
                        selectContainer.appendChild(optionDiv);
                    });
                    itemDiv.appendChild(selectContainer);
                    break;

                case 'select':
                    const select = document.createElement('select');
                    select.id = key;
                    attribute.options.forEach(option => {
                        const optionElement = document.createElement('option');
                        optionElement.value = option;
                        optionElement.textContent = option;
                        optionElement.selected = option === attribute.value;
                        select.appendChild(optionElement);
                    });
                    itemDiv.appendChild(select);
                    break;

                case 'boolean_group':
                    const facilitiesContainer = document.createElement('div');
                    facilitiesContainer.className = 'facilities-container';
                    
                    // Группируем удобства
                    const facilityGroups = {
                        main: {
                            title: 'Основные удобства',
                            items: ['changingRooms', 'showerAvailable', 'parkingAvailability']
                        },
                        sport: {
                            title: 'Спортивный инвентарь',
                            items: ['racketRental', 'ballAvailability', 'stringingService', 'equipmentAvailable','cueRental']
                        },
                        additional: {
                            title: 'Дополнительные услуги',
                            items: ['wifiAvailable', 'cafeAvailable', 'coachAvailable', 'lightingAvailable']
                        }
                    };

                    const facilityIcons = {
                        racketRental: '🎾',
                        ballAvailability: '⚾',
                        changingRooms: '🚪',
                        showerAvailable: '🚿',
                        parkingAvailability: '🅿️',
                        wifiAvailable: '📶',
                        cafeAvailable: '☕',
                        coachAvailable: '👨‍🏫',
                        lightingAvailable: '💡',
                        equipmentAvailable: '🎽',
                        stringingService: '🔧',
                        cueRental: '🎭'
                    };

                    const facilityNames = {
                        racketRental: 'Аренда ракеток',
                        ballAvailability: 'Мячи',
                        changingRooms: 'Раздевалки',
                        showerAvailable: 'Душевые',
                        parkingAvailability: 'Парковка',
                        wifiAvailable: 'Wi-Fi',
                        cafeAvailable: 'Кафе',
                        coachAvailable: 'Тренер',
                        lightingAvailable: 'Освещение',
                        equipmentAvailable: 'Экипировка',
                        stringingService: 'Натяжка ракеток',
                        cueRental: 'Аренда кия'
                    };

                    Object.entries(facilityGroups).forEach(([groupKey, group]) => {
                        const groupContainer = document.createElement('div');
                        groupContainer.className = 'facility-group';
                        
                        const groupTitle = document.createElement('h4');
                        groupTitle.className = 'facility-group-title';
                        groupTitle.textContent = group.title;
                        groupContainer.appendChild(groupTitle);

                        const groupItems = document.createElement('div');
                        groupItems.className = 'facility-group-items';

                        group.items.forEach(facilityKey => {
                            if (attribute.value.hasOwnProperty(facilityKey)) {
                                const facilityDiv = document.createElement('div');
                                facilityDiv.className = 'facility-item';
                                
                                const facilityLabel = document.createElement('label');
                                facilityLabel.className = 'facility-label';
                                
                                const facilityCheckbox = document.createElement('input');
                                facilityCheckbox.type = 'checkbox';
                                facilityCheckbox.name = facilityKey;
                                facilityCheckbox.id = `facility-${facilityKey}`;
                                facilityCheckbox.checked = attribute.value[facilityKey];
                                facilityCheckbox.className = 'facility-checkbox';
                                
                                const facilityIcon = document.createElement('span');
                                facilityIcon.className = 'facility-icon';
                                facilityIcon.textContent = facilityIcons[facilityKey];

                                const facilityText = document.createElement('span');
                                facilityText.className = 'facility-name';
                                facilityText.textContent = facilityNames[facilityKey];
                                
                                facilityLabel.appendChild(facilityCheckbox);
                                facilityLabel.appendChild(facilityIcon);
                                facilityLabel.appendChild(facilityText);
                                facilityDiv.appendChild(facilityLabel);

                                // Обновляем классы при изменении
                                facilityCheckbox.addEventListener('change', function() {
                                    facilityDiv.classList.toggle('active', this.checked);
                                    facilityDiv.classList.toggle('inactive', !this.checked);
                                });

                                facilityDiv.classList.add(attribute.value[facilityKey] ? 'active' : 'inactive');
                                groupItems.appendChild(facilityDiv);
                            }
                        });

                        groupContainer.appendChild(groupItems);
                        facilitiesContainer.appendChild(groupContainer);
                    });
                    
                    itemDiv.appendChild(facilitiesContainer);
                    break;

                case 'dynamic_time_price':
                    const priceContainer = document.createElement('div');
                    priceContainer.className = 'dynamic-price-container';

                    const timeRanges = document.createElement('div');
                    timeRanges.className = 'time-ranges';
                    timeRanges.id = `${key}_ranges`;

                    // Добавляем существующие временные интервалы
                    if (attribute.value && Array.isArray(attribute.value)) {
                        attribute.value.forEach(range => {
                            const rangeItem = document.createElement('div');
                            rangeItem.className = 'time-range-item';
                            rangeItem.innerHTML = `
                                <div class="time-range">
                                    <span class="time-icon">🕒</span>
                                    <input type="time" class="time-start" value="${range.timeRange.start}" required>
                                    <span class="time-separator">—</span>
                                    <input type="time" class="time-end" value="${range.timeRange.end}" required>
                                </div>
                                <div class="price-value">
                                    <span class="price-icon">💰</span>
                                    <input type="number" class="price" value="${range.price}" required>
                                    <span class="currency">сум</span>
                                </div>
                                <div class="price-description">
                                    <span class="desc-icon">📝</span>
                                    <input type="text" class="description" value="${range.description.ru}" placeholder="Описание тарифа" required>
                                </div>
                                <button type="button" class="delete-range" onclick="deleteTimeRange(this)">✕</button>
                            `;
                            timeRanges.appendChild(rangeItem);
                        });
                    }

                    const addButton = document.createElement('button');
                    addButton.type = 'button';
                    addButton.className = 'add-time-range';
                    addButton.innerHTML = '<span class="add-icon">+</span> Добавить временной интервал';
                    addButton.onclick = () => addTimeRange(key);

                    priceContainer.appendChild(timeRanges);
                    priceContainer.appendChild(addButton);
                    itemDiv.appendChild(priceContainer);
                    break;

                case 'json':
                    if (key === 'openHours') {
                        const scheduleContainer = createWorkingHoursSection(attribute);
                        itemDiv.appendChild(scheduleContainer);
                    }
                    break;

                default:
                    const defaultInput = document.createElement('input');
                    defaultInput.type = 'text';
                    defaultInput.id = key;
                    defaultInput.value = attribute.value || '';
                    itemDiv.appendChild(defaultInput);
            }

            return itemDiv;
        }

        function addTimeRange(key) {
            const timeRanges = document.getElementById(`${key}_ranges`);
            const rangeItem = document.createElement('div');
            rangeItem.className = 'time-range-item';

            rangeItem.innerHTML = `
                <input type="time" class="time-start" value="09:00" required>
                <input type="time" class="time-end" value="22:00" required>
                <div class="price-description">
                    <input type="number" class="price" placeholder="Цена" required>
                    <input type="text" class="description" placeholder="Описание тарифа" required>
                </div>
                <button type="button" class="delete-range" onclick="deleteTimeRange(this)">✕</button>
            `;

            timeRanges.appendChild(rangeItem);
        }

        function deleteTimeRange(button) {
            const timeRanges = document.getElementById(`${button.parentElement.dataset.attribute}_ranges`);
            if (timeRanges.children.length > 1) {
                button.parentElement.remove();
            } else {
                alert('Должен быть хотя бы один временной интервал');
            }
        }

        function updateStepIndicators(step) {
            const dots = document.querySelectorAll('.step-dot');
            dots.forEach((dot, index) => {
                dot.classList.toggle('active', index + 1 <= step);
            });
        }

        function nextStep(step) {
            if (validateStep(getCurrentStep())) {
                document.querySelectorAll('.step').forEach((el) => el.classList.remove('active'));
                document.getElementById('step' + step).classList.add('active');
                document.getElementById('progress').querySelector('span').textContent = `Шаг ${step} из 3`;
                updateStepIndicators(step);
            }
        }

        function prevStep(step) {
            document.querySelectorAll('.step').forEach((el) => el.classList.remove('active'));
            document.getElementById('step' + step).classList.add('active');
            document.getElementById('progress').querySelector('span').textContent = `Шаг ${step} из 3`;
            updateStepIndicators(step);
        }

        function getCurrentStep() {
            const activeStep = document.querySelector('.step.active');
            return parseInt(activeStep.id.replace('step', ''));
        }

        function validateStep(step) {
            // Сначала очищаем все предыдущие ошибки
            clearErrors();

            switch(step) {
                case 1:
                    let isValid = true;
                    const email = document.getElementById('email').value;
                    const password = document.getElementById('password').value;
                    const phone = document.getElementById('phone').value;

                    // Валидация email
                    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                    if (!emailRegex.test(email)) {
                        showError('email', 'Введите корректный email адрес');
                        isValid = false;
                    }

                    // Валидация пароля
                    const passwordRegex = /^(?=.*[A-Z])(?=.*\d).{6,}$/;
                    if (!passwordRegex.test(password)) {
                        showError('password', 'Пароль должен содержать минимум 6 символов, включая заглавную букву и цифру');
                        isValid = false;
                    }

                    // Валидация телефона
                    const phoneRegex = /^\+998[0-9]{9}$/;
                    if (!phoneRegex.test(phone)) {
                        showError('phone', 'Введите корректный номер телефона в формате +998XXXXXXXXX');
                        isValid = false;
                    }

                    return isValid;
                case 2:
                    const sportType = document.getElementById('sportType').value;
                    const orgType = document.getElementById('orgType').value;
                    const address = document.getElementById('address').value;
                    const description = document.getElementById('description').value;
                    const latitude = document.getElementById('latitude').value;
                    const longitude = document.getElementById('longitude').value;
                    const orgName = document.getElementById('orgName').value;

                    if (!sportType || !orgType || !address || !description || !latitude || !longitude || !orgName) {
                        alert('Пожалуйста, заполните все поля');
                        return false;
                    }

                    // Валидация координат
                    if (isNaN(latitude) || latitude < -90 || latitude > 90) {
                        showError('latitude', 'Широта должна быть в диапазоне от -90 до 90');
                        return false;
                    }

                    if (isNaN(longitude) || longitude < -180 || longitude > 180) {
                        showError('longitude', 'Долгота должна быть в диапазоне от -180 до 180');
                        return false;
                    }

                    // Валидация описания
                    if (description.trim().length < 10) {
                        showError('description', 'Описание должно содержать не менее 10 символов');
                        return false;
                    }

                    return true;
                case 3:
                    // Здесь можно добавить валидацию атрибутов
                    return true;
                default:
                    return true;
            }
        }

        function confirmRegistration() {
            if (confirm("Вы уверены, что хотите зарегистрироваться как бизнес организация в системе Place&Play?")) {
                register();
            }
        }

        function collectFormData() {
            const formData = {
                email: document.getElementById('email').value,
                password: document.getElementById('password').value,
                phone: document.getElementById('phone').value,
                orgName: document.getElementById('orgName').value,
                address: document.getElementById('address').value,
                sportTypeId: parseInt(window.selectedSportId),
                currentLocation: 1,
                sportIds: [parseInt(window.selectedSportId)],
                orgType: document.getElementById('sportType').options[document.getElementById('sportType').selectedIndex].text,
                
                // Добавляем поля description, latitude и longitude на верхнем уровне
                description: document.getElementById('description').value,
                latitude: parseFloat(document.getElementById('latitude').value),
                longitude: parseFloat(document.getElementById('longitude').value),
                
                orgInfo: {
                    name: {
                        en: document.getElementById('orgName').value,
                        ru: document.getElementById('orgName').value,
                        uz: document.getElementById('orgName').value
                    },
                    sportName: {
                        en: document.getElementById('sportType').options[document.getElementById('sportType').selectedIndex].text,
                        ru: document.getElementById('sportType').options[document.getElementById('sportType').selectedIndex].text,
                        uz: document.getElementById('sportType').options[document.getElementById('sportType').selectedIndex].text
                    },
                    attributes: {}
                }
            };

            // Собираем атрибуты
            const savedAttributes = window.selectedSportData.orgInfo.attributes;
            for (const [key, attr] of Object.entries(savedAttributes)) {
                const attributeValue = getAttributeValue(key, attr.input);
                formData.orgInfo.attributes[key] = {
                    name: attr.name,
                    input: attr.input,
                    value: attributeValue
                };
                if (attr.options) {
                    formData.orgInfo.attributes[key].options = attr.options;
                }
            }

            console.log('Отправляемые данные:', formData); // Добавляем лог для проверки
            return formData;
        }

        function getAttributeValue(key, inputType) {
            const element = document.querySelector(`[data-attribute="${key}"]`);
            if (!element) return null;

            switch (inputType) {
                case 'boolean':
                    return element.querySelector('input[type="checkbox"]').checked;

                case 'int':
                    return parseInt(element.querySelector('input[type="number"]').value) || 0;

                case 'decimal':
                    return parseFloat(element.querySelector('input[type="number"]').value) || 0;

                case 'select':
                    return element.querySelector('select').value;

                case 'multiselect':
                    const selectedCheckboxes = element.querySelectorAll('input[type="checkbox"]:checked');
                    return Array.from(selectedCheckboxes).map(cb => parseInt(cb.value));

                case 'boolean_group':
                    const checkboxes = element.querySelectorAll('input[type="checkbox"]');
                    const values = {};
                    checkboxes.forEach(cb => {
                        values[cb.name] = cb.checked;
                    });
                    return values;

                case 'dynamic_time_price':
                    const ranges = element.querySelectorAll('.time-range-item');
                    const timeRanges = [];

                    ranges.forEach(range => {
                        timeRanges.push({
                            timeRange: {
                                start: range.querySelector('.time-start').value,
                                end: range.querySelector('.time-end').value
                            },
                            price: parseInt(range.querySelector('.price').value),
                            description: {
                                en: range.querySelector('.description').value,
                                ru: range.querySelector('.description').value,
                                uz: range.querySelector('.description').value
                            }
                        });
                    });
                    return timeRanges;

                case 'json':
                    if (key === 'openHours') {
                        const section = element.querySelector('.working-hours-section');
                        return {
                            active: section.querySelector('#working-hours-active').checked,
                            schedule: {
                                monday: {
                                    isWorking: section.querySelector('#monday-working').checked,
                                    start: section.querySelector('#monday-start').value,
                                    end: section.querySelector('#monday-end').value
                                },
                                tuesday: {
                                    isWorking: section.querySelector('#tuesday-working').checked,
                                    start: section.querySelector('#tuesday-start').value,
                                    end: section.querySelector('#tuesday-end').value
                                },
                                wednesday: {
                                    isWorking: section.querySelector('#wednesday-working').checked,
                                    start: section.querySelector('#wednesday-start').value,
                                    end: section.querySelector('#wednesday-end').value
                                },
                                thursday: {
                                    isWorking: section.querySelector('#thursday-working').checked,
                                    start: section.querySelector('#thursday-start').value,
                                    end: section.querySelector('#thursday-end').value
                                },
                                friday: {
                                    isWorking: section.querySelector('#friday-working').checked,
                                    start: section.querySelector('#friday-start').value,
                                    end: section.querySelector('#friday-end').value
                                },
                                saturday: {
                                    isWorking: section.querySelector('#saturday-working').checked,
                                    start: section.querySelector('#saturday-start').value,
                                    end: section.querySelector('#saturday-end').value
                                },
                                sunday: {
                                    isWorking: section.querySelector('#sunday-working').checked,
                                    start: section.querySelector('#sunday-start').value,
                                    end: section.querySelector('#sunday-end').value
                                }
                            }
                        };
                    }
                    return null;

                default:
                    return element.querySelector('input').value;
            }
        }

        // Функция регистрации
        function register() {
            const formData = collectFormData();
            
            console.log('Отправляемые данные:', formData);

            fetch('/PlaceAndPlay/api/organizations/registration', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'User-Agent': 'insomnia/10.3.1',
                    'language': 'ru'
                },
                credentials: 'include',
                body: JSON.stringify(formData)
            })
            .then(response => response.json())
            .then(data => {
                console.log('Ответ сервера:', data);
                alert('Регистрация успешно завершена!');
                // Перенаправляем на страницу логина
                window.location.href = '/login.html';
            })
            .catch(error => {
                console.error('Ошибка при регистрации:', error);
                alert('Произошла ошибка при регистрации. Пожалуйста, попробуйте снова.');
            });
        }

        function createWorkingHoursSection(attribute) {
            const workingHoursSection = document.createElement('div');
            workingHoursSection.className = 'working-hours-section';

            const header = document.createElement('div');
            header.className = 'section-header';
            
            const toggleContainer = document.createElement('div');
            toggleContainer.className = 'working-hours-toggle';
            toggleContainer.style.marginBottom = '20px';
            
            const toggleLabel = document.createElement('span');
            toggleLabel.textContent = 'График работы активен';
            toggleLabel.style.marginRight = '10px';

            const toggleInput = document.createElement('input');
            toggleInput.type = 'checkbox';
            toggleInput.id = 'working-hours-active';
            toggleInput.checked = attribute.value?.active ?? true;

            toggleContainer.appendChild(toggleLabel);
            toggleContainer.appendChild(toggleInput);
            header.appendChild(toggleContainer);
            workingHoursSection.appendChild(header);

            const daysContainer = document.createElement('div');
            daysContainer.className = 'days-container';

            const days = {
                monday: 'Понедельник',
                tuesday: 'Вторник',
                wednesday: 'Среда',
                thursday: 'Четверг',
                friday: 'Пятница',
                saturday: 'Суббота',
                sunday: 'Воскресенье'
            };

            Object.entries(days).forEach(([dayKey, dayName]) => {
                const daySchedule = attribute.value?.schedule?.[dayKey] || { 
                    isWorking: true, 
                    start: '09:00', 
                    end: '22:00' 
                };

                const dayRow = document.createElement('div');
                dayRow.className = 'day-schedule';

                const dayLabel = document.createElement('div');
                dayLabel.className = 'day-name';
                dayLabel.textContent = dayName;

                const timeContainer = document.createElement('div');
                timeContainer.className = 'time-inputs';

                const startTime = document.createElement('input');
                startTime.type = 'time';
                startTime.id = `${dayKey}-start`;
                startTime.value = daySchedule.start;

                const separator = document.createElement('span');
                separator.textContent = '—';
                separator.style.color = '#666';

                const endTime = document.createElement('input');
                endTime.type = 'time';
                endTime.id = `${dayKey}-end`;
                endTime.value = daySchedule.end;

                const workingToggle = document.createElement('div');
                workingToggle.className = 'working-day-toggle';

                const workingCheckbox = document.createElement('input');
                workingCheckbox.type = 'checkbox';
                workingCheckbox.id = `${dayKey}-working`;
                workingCheckbox.checked = daySchedule.isWorking;

                const workingLabel = document.createElement('label');
                workingLabel.htmlFor = `${dayKey}-working`;
                workingLabel.textContent = 'Рабочий день';

                workingCheckbox.addEventListener('change', function() {
                    startTime.disabled = !this.checked;
                    endTime.disabled = !this.checked;
                    dayRow.classList.toggle('disabled', !this.checked);
                });

                timeContainer.appendChild(startTime);
                timeContainer.appendChild(separator);
                timeContainer.appendChild(endTime);

                workingToggle.appendChild(workingCheckbox);
                workingToggle.appendChild(workingLabel);

                dayRow.appendChild(dayLabel);
                dayRow.appendChild(timeContainer);
                dayRow.appendChild(workingToggle);

                if (!daySchedule.isWorking) {
                    startTime.disabled = true;
                    endTime.disabled = true;
                    dayRow.classList.add('disabled');
                }

                daysContainer.appendChild(dayRow);
            });

            workingHoursSection.appendChild(daysContainer);
            return workingHoursSection;
        }

        // Функция для очистки ошибок
        function clearErrors() {
            const errorElements = document.querySelectorAll('.input-error');
            const inputGroups = document.querySelectorAll('.input-group');
            
            errorElements.forEach(error => error.textContent = '');
            inputGroups.forEach(group => group.classList.remove('error'));
        }

        // Обновляем функцию показа ошибок
        function showError(fieldId, message) {
            const field = document.getElementById(fieldId);
            const group = field.closest('.input-group');
            const errorDiv = group.querySelector('.input-error');
            
            group.classList.add('error');
            errorDiv.textContent = message;
        }

        // Добавляем обработчики событий для валидации в реальном времени
        document.addEventListener('DOMContentLoaded', function() {
            const email = document.getElementById('email');
            const password = document.getElementById('password');
            const phone = document.getElementById('phone');

            // Очищаем ошибку при начале ввода
            email.addEventListener('input', function() {
                const group = this.closest('.input-group');
                group.classList.remove('error');
                group.querySelector('.input-error').textContent = '';
            });

            password.addEventListener('input', function() {
                const group = this.closest('.input-group');
                group.classList.remove('error');
                group.querySelector('.input-error').textContent = '';
            });

            phone.addEventListener('input', function() {
                const group = this.closest('.input-group');
                group.classList.remove('error');
                group.querySelector('.input-error').textContent = '';
            });
        });
    </script>
</body>
</html> 